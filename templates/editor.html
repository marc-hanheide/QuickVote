$def with (data)

$var title: QuickVote Editor (Admin)

<script type="text/javascript">

	// results_source = null;

	// function update_results(data) {
	// 	// Get the context of the canvas element we want to select

	// 	$$("div#total").text(data['totals']);
	// 	$$("div#correct").text(data['corrects']);
	// 	// change colour according to level later on:
	// 	//$$("div#ratio").parent().parent().attr('class', 'btn btn-lg btn-block btn-warning')
	// 	$$("div#ratio").text(data['percent']);
	// 	$$("div#sensitivity").text(data['sensitivity']);
	// 	$$("div#specificity").text(data['specificity']);
	// 	$$("div#accuracy").text(data['accuracy']);


	// }


	function enable_paste() {
		document.getElementById('image').onpaste = function (event) {
		  // use event.originalEvent.clipboard for newer chrome versions
		  var items = (event.clipboardData  || event.originalEvent.clipboardData).items;
		  console.log(JSON.stringify(items)); // will give you the mime types
		  // find pasted image among pasted items
		  var blob = null;
		  for (var i = 0; i < items.length; i++) {
		    if (items[i].type.indexOf("image") === 0) {
		      blob = items[i].getAsFile();
		    }
		  }
		  // load image if there is a pasted image
		  if (blob !== null) {
		    var reader = new FileReader();
		    reader.onload = function(event) {
		      console.log(event.target.result); // data url!
		      document.getElementById("pastedImage").src = event.target.result;
		      document.getElementById("image").value = event.target.result;
		    };
		    reader.readAsDataURL(blob);
		  }
		}
	}


	function choose(id) {
		param = {
		}
		$$.getJSON("$data['get_url']" + id, param, function(data) {
			$$("#uuid").val(data['uuid']);
			$$("#domain").val(data['domain']);
			$$("#question").val(data['question']);
			$$("#options").val(data['options']);
			//$$("#image").val(data['image']);
			$$('#base64Image').val(data['image']);
			$$("#correct_opt").val(data['correct']);
			$$("#active_question").text(data['question'].substring(0,32));

		    document.getElementById("pastedImage").src = data['image'];

			// if (results_source != null) {
			// 	results_source.close();
			// }
			// results_source = new EventSource("$data['get_results_url']" + data['uuid']);

			// results_source.onmessage = function(event) {
			//     update_results(JSON.parse(event.data));
			// };


		});

	}

	// function delete_answers() {
	// 	var question_uuid = $$("#uuid").val();
	// 	console.log("delete all answers for " + question_uuid)
	// 	$$.post("$data['delete_url']" + question_uuid, function(data) {
	// 		choose(question_uuid);
	// 	});

	// }

	function new_session() {
		var question_uuid = $$("#uuid").val();
		console.log("new session for " + question_uuid)
		$$.post("$data['delete_url']" + question_uuid, function(data) {
			choose(question_uuid);
		});

	}

	function new_question() {
		$$("#uuid").val("$data['new_uuid']");
		$$("#domain").val("$data['domain']");
		$$("#question").val("");
		$$("#options").val("");
		$$("#correct_opt").val("");
	}

	function submit_edits() {
		console.log("save")
		var d = $$( "#editform" ).serialize()
		$$.post("$data['submit_url']", d, function() {
			location.reload();
		});
	}

	function delete_question(){
		//TODO: Data validation
		var questionName = $$("#question").val();
		var toPost = $$("#editform").serialize();

		bootbox.dialog({
			message: "Are you sure you want to delete the question \""+questionName+"\"",
			title: "Confirm deletion",
			show: true,
			backdrop: true,
			closeButton: true,
			animate: true,
			className: "my-modal",
			buttons: {
				"Yes, delete": {
					className: "btn-success",
					callback: function() {
						//They are sure
						toPost = toPost + "&delete_question=true"; //Make sure the app knows we confirmed and want to delete
						console.log(toPost);
						$$.post("$data['submit_url']", toPost, function() {
							location.reload();
						});
					}
				},
				"No, don't delete": {
					className: "btn-danger"
				}
			}
		});
	}

	function readImage(){
		if (this.files && this.files[0]) {
		    var fileReader = new FileReader();
			console.log("Reading file: "+ this.files[0].name);
			$$('#selectedImage').val(this.files[0].name); // Show user that we're reading their file
		    fileReader.onload = function(e) {
				console.log("Loaded fileReader");
				$$('#base64Image').val (e.target.result); // Allow user to see image uploaded
				$$('#pastedImage').attr('src', e.target.result); // Set the data we're sending to the server
		    };

		    fileReader.readAsDataURL( this.files[0] );
		}
	}

	$$(document).ready(function () {
		//Old upload method
		//enable_paste();
		//New upload method
		$$("#image").on("change", readImage);

		if ("$data['active_question']" != "")
			choose("$data['active_question']");
	});


</script>


<div class="row">
	<div class="panel panel-default">
  	<div class="panel-heading">
    	<h3 class="panel-title">Editor</h3>
  	</div>
  	<div class="panel-body">

		<div class="col-md-12">
			<div class="btn-group">
				<button id="active_question" class="btn btn-default">
					Question
				</button>
				<button data-toggle="dropdown" class="btn btn-default dropdown-toggle">
					<span class="caret"></span>
				</button>
				<ul class="dropdown-menu scrollable-menu">
					<li>
						<a onclick="new_question();">New</a>
					</li>
					<li class="divider">
					$for q in data['existing_questions']:
						</li>
						<li>
							<a onclick="choose(this.id);" id="$q['uuid']">$q['question']</a>
						</li>
				</ul>
			</div>

			<form role="form" id="editform">
				<small>
				<div class="form-group">

					<label for="uuid">
						UUID
					</label>
					<input type="text" readonly="readonly" class="form-control" name="uuid" id="uuid" />
				</div>
				<div class="form-group">

					<label for="domain">
						domain
					</label>
					<input type="text" readonly="readonly" class="form-control" name="domain" id="domain" />
				</div>
				</small>
				<div class="form-group">

					<label for="question">
						Question
					</label>
					<input type="text" class="form-control" name="question" id="question" placeholder="enter your question here, e.g. What is the meaning of life?"/>
				</div>
					<div class="media">
					  	<div class="media-body">
							<div class="form-group">

								<label for="image">
									Image
								</label>
								<!-- Old upload method
								<input type="text" class="media-heading " name="image" id="image" placeholder="paste any image here"/>
								-->
								<div class="input-group">
									<input id="selectedImage" placeholder="Choose File" disabled="disabled" />
									<div class="fileUpload btn btn-primary" style="clear: both;">
									    <span>Upload Image</span>
									    <input id="image" type="file" accept="image/*" class="upload" />
									</div>
									<!-- To make sure the image data gets sent to the server -->
									<input type="text" name="image" id="base64Image" readonly hidden />
								</div>
							</div>
						  	<div class="media-right">
				      			<img  height="200px" class="media-object" id="pastedImage"/>
						  	</div>
					</div>
				</div>
				<div class="form-group">

					<label for="options">
						Options (comma-separated)
					</label>
					<input type="text" class="form-control" name="options" id="options" placeholder="comma-separated list of options, e.g. A,B,C"/>
				</div>
				<div class="form-group">

					<label for="correct_opt">
						All correct options (comma-separated)
					</label>
					<input type="text" class="form-control" name="correct" id="correct_opt" placeholder="comma-separated list of CORRECT options, e.g. B,C"/>
				</div>
				<button type="button" class="btn btn-default" onclick="submit_edits();">
					Save
				</button>
				<button type="button" class="btn btn-danger" onclick="delete_question();">
					Delete
				</button>
			</form>
		</div>
	</div>
</div>
